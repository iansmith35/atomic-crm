<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alex's Office - Atomic CRM</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .office-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; }
        .content-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .data-section { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .data-section h3 { margin-top: 0; color: #667eea; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem; }
        .task-item, .contact-item, .event-item { padding: 0.75rem; margin: 0.5rem 0; border-left: 3px solid #667eea; background: #f8f9fa; border-radius: 4px; }
        .priority-high { border-left-color: #ff4757; }
        .priority-medium { border-left-color: #ffa502; }
        .loading { text-align: center; padding: 2rem; color: #999; }
        .empty-state { text-align: center; padding: 2rem; color: #999; font-style: italic; }
        .stats-bar { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .stat-card { flex: 1; min-width: 150px; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 0.9rem; margin-top: 0.25rem; }
        .chatbot-section { margin-top: 2rem; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .chatbot-iframe { width: 100%; height: 600px; border: none; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header>
            <h1>üè¢ Alex's Office</h1>
            <nav><a href="index.html">‚Üê Back to Dashboard</a></nav>
        </header>

        <div class="office-header">
            <h2>Alex</h2>
            <p><strong>Department:</strong> Operations | <strong>Business:</strong> ISHE</p>
        </div>

        <div class="stats-bar">
            <div class="stat-card"><div class="stat-number" id="task-count">-</div><div class="stat-label">Active Tasks</div></div>
            <div class="stat-card"><div class="stat-number" id="contact-count">-</div><div class="stat-label">Contacts</div></div>
            <div class="stat-card"><div class="stat-number" id="event-count">-</div><div class="stat-label">Events</div></div>
        </div>

        <div class="content-grid">
            <div class="data-section">
                <h3>üìã Active Tasks</h3>
                <div id="tasks-list" class="loading">Loading...</div>
            </div>
            <div class="data-section">
                <h3>üë• Contacts</h3>
                <div id="contacts-list" class="loading">Loading...</div>
            </div>
            <div class="data-section">
                <h3>üìÖ Events</h3>
                <div id="events-list" class="loading">Loading...</div>
            </div>
        </div>

        <div class="chatbot-section">
            <h3>üí¨ Chat with Alex</h3>
            <iframe class="chatbot-iframe" src="https://app.rube.ai/chat/embed/cm1hcbqj70012e5g33p0k9h8f" allow="clipboard-write"></iframe>
        </div>
    </div>

    <script>
        const API = 'https://mydxasjicsfetnglbppp.supabase.co/rest/v1';
        const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15ZHhhc2ppY3NmZXRuZ2xicHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY2NzYyMTQsImV4cCI6MjA0MjI1MjIxNH0.m0N4_7YqKq3-YmqPF-h_wNd6jgNpg8OjPGPRuDfVHQg';
        const headers = { 'apikey': KEY, 'Authorization': `Bearer ${KEY}` };

        async function loadTasks() {
            try {
                const r = await fetch(`${API}/tasks?or=(category.eq.operations,business.eq.ISHE,assigned_to.ilike.%25Alex%25)&status=eq.open&limit=20`, {headers});
                const tasks = await r.json();
                document.getElementById('task-count').textContent = tasks.length;
                document.getElementById('tasks-list').innerHTML = tasks.length ? tasks.map(t => 
                    `<div class="task-item priority-${t.priority||'low'}"><strong>${t.title||t.task_name}</strong><p>${t.description||''}</p><small>Due: ${t.due_date||'TBD'}</small></div>`
                ).join('') : '<div class="empty-state">No tasks</div>';
            } catch(e) { document.getElementById('tasks-list').innerHTML = '<div class="empty-state">Error</div>'; }
        }

        async function loadContacts() {
            try {
                const r = await fetch(`${API}/contacts?status=eq.active&limit=10&order=created_at.desc`, {headers});
                const contacts = await r.json();
                document.getElementById('contact-count').textContent = contacts.length;
                document.getElementById('contacts-list').innerHTML = contacts.length ? contacts.map(c => 
                    `<div class="contact-item"><strong>${c.name}</strong><p>${c.email||''}</p><small>${c.notes||''}</small></div>`
                ).join('') : '<div class="empty-state">No contacts</div>';
            } catch(e) { document.getElementById('contacts-list').innerHTML = '<div class="empty-state">Error</div>'; }
        }

        async function loadEvents() {
            try {
                const r = await fetch(`${API}/calendar_event_backups?limit=10&order=backup_timestamp.desc`, {headers});
                const events = await r.json();
                document.getElementById('event-count').textContent = events.length;
                document.getElementById('events-list').innerHTML = events.length ? events.slice(0,5).map(e => {
                    const s = e.event_snapshot || {};
                    return `<div class="event-item"><strong>${s.summary||'Event'}</strong><p>${s.description||''}</p><small>${new Date(s.start?.dateTime||s.start?.date||e.backup_timestamp).toLocaleString()}</small></div>`;
                }).join('') : '<div class="empty-state">No events</div>';
            } catch(e) { document.getElementById('events-list').innerHTML = '<div class="empty-state">Error</div>'; }
        }

        loadTasks(); loadContacts(); loadEvents();
        setInterval(() => { loadTasks(); loadContacts(); loadEvents(); }, 30000);
    </script>
</body>
</html>