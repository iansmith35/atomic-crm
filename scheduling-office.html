<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduling Office - Calendar Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold flex items-center">
                        üìÖ Scheduling Office
                    </h1>
                    <p class="text-indigo-100 mt-2">AI-powered calendar management & scheduling assistance</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="activeTasksCount">7</div>
                    <div class="text-sm text-indigo-200">Active Tasks</div>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-1 gap-8">
            <!-- Calendar Overview -->
            <section class="mb-8">
                <h2 class="text-xl font-bold mb-4">üìÖ Calendar Events</h2>
                <ul id="calendarEvents" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Calendar events will be loaded here -->
                </ul>
            </section>

            <!-- Task Board -->
            <section>
                <h2 class="text-xl font-bold mb-4">üìã Scheduling Requests</h2>
                <ul id="schedulingTasks" class="space-y-4">
                    <!-- Scheduling tasks will be loaded here -->
                </ul>
            </section>
        </div>

        <!-- AI Suggestion Modal -->
        <div id="aiSuggestionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-bold mb-4">ü§ñ AI Scheduling Suggestion</h3>
                <div id="aiSuggestionContent" class="mb-4 p-3 bg-gray-700 rounded-lg">
                    <!-- AI suggestion content -->
                </div>
                <div class="flex gap-2">
                    <button id="confirmSuggestion" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex-1">
                        ‚úÖ Confirm & Send
                    </button>
                    <button id="editSuggestion" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm flex-1">
                        ‚úèÔ∏è Edit First
                    </button>
                    <button id="closeSuggestion" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                        ‚úï
                    </button>
                </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="mt-8 text-center">
            <a href="index.html" class="inline-block bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg font-semibold">
                ‚Üê Back to Office Dashboard
            </a>
        </div>
    </div>

    <script>
        // State management
        let tasks = [];
        let calendarEvents = [];
        let currentAiSuggestion = null;

        // Sample data for demonstration
        const sampleTasks = [
            {
                id: 1,
                subject: "Meeting with John Smith",
                description: "Discuss quarterly project goals and timeline adjustments"
            },
            {
                id: 2,
                subject: "Team standup",
                description: "Weekly team synchronization and progress updates"
            },
            {
                id: 3,
                subject: "Client presentation",
                description: "Present new features to the client stakeholders"
            }
        ];

        const sampleCalendarEvents = [
            {
                summary: "Weekly Team Meeting",
                start: "2024-01-15 10:00",
                end: "2024-01-15 11:00",
                source: "Google Calendar"
            },
            {
                summary: "Client Call - ProjectX",
                start: "2024-01-15 14:00",
                end: "2024-01-15 15:30",
                source: "Manual"
            },
            {
                summary: "Design Review",
                start: "2024-01-16 09:00",
                end: "2024-01-16 10:00",
                source: "Outlook"
            }
        ];

        // AI suggestion responses
        const aiSuggestions = [
            "Based on your calendar, I suggest scheduling this meeting for Tuesday 2:00 PM - 3:00 PM. This slot avoids conflicts with your existing commitments and allows buffer time between meetings.",
            "I recommend scheduling this for Wednesday morning at 10:00 AM. This time works well with team availability and follows your preferred meeting patterns.",
            "The best available slot appears to be Thursday 3:00 PM - 4:00 PM. This gives everyone adequate preparation time and doesn't conflict with the quarterly review.",
            "I suggest Monday 11:00 AM - 12:00 PM for this meeting. This timing optimizes for participant availability and energy levels based on historical data."
        ];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadCalendarEvents();
            loadSchedulingTasks();
            setupEventListeners();
        });

        // Load calendar events
        function loadCalendarEvents() {
            const container = document.getElementById('calendarEvents');
            
            // Try to fetch from API first, fallback to sample data
            fetchCalendarEvents().then(events => {
                calendarEvents = events;
                renderCalendarEvents();
            }).catch(() => {
                calendarEvents = sampleCalendarEvents;
                renderCalendarEvents();
            });
        }

        // Load scheduling tasks
        function loadSchedulingTasks() {
            fetchSchedulingTasks().then(fetchedTasks => {
                tasks = fetchedTasks;
                renderSchedulingTasks();
            }).catch(() => {
                tasks = sampleTasks;
                renderSchedulingTasks();
            });
        }

        // Render calendar events
        function renderCalendarEvents() {
            const container = document.getElementById('calendarEvents');
            container.innerHTML = '';

            calendarEvents.forEach((event, i) => {
                const eventElement = document.createElement('li');
                eventElement.className = 'p-4 border border-gray-600 rounded-xl bg-gray-800 shadow-sm';
                eventElement.innerHTML = `
                    <div class="font-bold text-white">${event.summary}</div>
                    <div class="text-sm text-gray-400">${event.start} ‚Üí ${event.end}</div>
                    <div class="text-sm text-gray-500">From: ${event.source || "Manual"}</div>
                `;
                container.appendChild(eventElement);
            });
        }

        // Render scheduling tasks
        function renderSchedulingTasks() {
            const container = document.getElementById('schedulingTasks');
            container.innerHTML = '';

            tasks.forEach((task) => {
                const taskElement = document.createElement('li');
                taskElement.className = 'p-4 border border-gray-600 rounded-xl bg-yellow-900 bg-opacity-30 shadow';
                taskElement.innerHTML = `
                    <div class="font-medium text-white">${task.subject}</div>
                    <p class="text-sm text-gray-300 mb-2">${task.description}</p>
                    <div class="flex gap-2">
                        <button
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm"
                            onclick="getAiSuggestion(${task.id})"
                        >
                            Ask AI for Date Options
                        </button>
                        <button 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-lg text-sm"
                            onclick="markTaskDone(${task.id})"
                        >
                            Mark as Done
                        </button>
                    </div>
                `;
                container.appendChild(taskElement);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('confirmSuggestion').addEventListener('click', confirmSuggestion);
            document.getElementById('editSuggestion').addEventListener('click', editSuggestion);
            document.getElementById('closeSuggestion').addEventListener('click', closeSuggestionModal);
        }

        // Fetch calendar events from API
        async function fetchCalendarEvents() {
            const response = await fetch('/api/calendar/events');
            const data = await response.json();
            return data.events || [];
        }

        // Fetch scheduling tasks from API
        async function fetchSchedulingTasks() {
            const response = await fetch('/api/scheduling/tasks');
            const data = await response.json();
            return data.tasks || [];
        }

        // Get AI suggestion for a task
        async function getAiSuggestion(taskId) {
            try {
                const response = await fetch('/api/ai/scheduling', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskId })
                });
                const data = await response.json();
                currentAiSuggestion = data.suggestion;
                showAiSuggestion(currentAiSuggestion);
            } catch (error) {
                // Fallback to sample suggestions
                const randomSuggestion = aiSuggestions[Math.floor(Math.random() * aiSuggestions.length)];
                currentAiSuggestion = randomSuggestion;
                showAiSuggestion(currentAiSuggestion);
            }
        }

        // Show AI suggestion modal
        function showAiSuggestion(suggestion) {
            document.getElementById('aiSuggestionContent').textContent = suggestion;
            document.getElementById('aiSuggestionModal').classList.remove('hidden');
        }

        // Close AI suggestion modal
        function closeSuggestionModal() {
            document.getElementById('aiSuggestionModal').classList.add('hidden');
            currentAiSuggestion = null;
        }

        // Confirm AI suggestion
        function confirmSuggestion() {
            alert('‚úÖ Scheduling confirmed! Email notification has been sent to all participants.');
            closeSuggestionModal();
        }

        // Edit AI suggestion
        function editSuggestion() {
            const newSuggestion = prompt('Edit the AI suggestion:', currentAiSuggestion);
            if (newSuggestion && newSuggestion.trim()) {
                currentAiSuggestion = newSuggestion.trim();
                showAiSuggestion(currentAiSuggestion);
            }
        }

        // Mark task as done
        function markTaskDone(taskId) {
            tasks = tasks.filter(task => task.id !== taskId);
            renderSchedulingTasks();
            
            // Update task count
            const taskCount = document.getElementById('activeTasksCount');
            taskCount.textContent = tasks.length;
            
            alert('‚úÖ Task marked as completed!');
        }
    </script>

<!-- GLOBAL CRM SETUP PAYLOAD FOR COPILOT DEPLOYMENT -->
<!-- DROP THIS INTO COPILOT AND DEPLOY ACROSS ALL HTML FILES -->
<!-- REPLACES GOOGLE AUTH, SUPERBASE CONNECTION, AND BACKEND SYNC -->

<!-- üß† LOAD RUBE CHATBOT WITH VOICE MAPPING -->
<script src="https://rube.app/embed/chat?agent=ellie-ai&apikey=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJ1c2VyXzAxSzUyNDJUVllBTlBNTjIxTVdZWUtBVlk1Iiwib3JnSWQiOiJvcmdfMDFLNTI0MzI5TVkxOFo5SlhQQTJKM1kxOVkiLCJpYXQiOjE3NTkwNzMzNjB9.dlelFFUO-TRCVA4Q7d4n5xArhN5sxCBBm4VLFxmaMZM"></script>
<script>
  const officeName = document.title || "CEO Office";
  const voiceMap = {
    "CEO Office": "Brian",
    "Admin Mailroom": "Stacy",
    "Logistics Office": "Ellie",
    "Accounts Office": "Ava",
    "Virtual Engineer": "Riley",
    "Therapy Room": "Luna"
  };
  window.addEventListener("load", () => {
    const aiAgent = document.querySelector("[rube-chat-agent]");
    if (aiAgent && voiceMap[officeName]) {
      aiAgent.setAttribute("voice", voiceMap[officeName]);
    }
  });
</script>

<!-- üîë SUPERBASE GLOBAL CONNECTION -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  window.supabase = createClient(
    'https://mydxasjicsfetnglbppp.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15ZHhhc2ppY3NmZXRuZ2xicHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMjYyNTQsImV4cCI6MjA3MzgwMjI1NH0.zdJa3T1WDdc6_JNQbh93oB7CnVWa5TQ5jLb1UN-8dLE'
  );
</script>

<!-- ‚úÖ GOOGLE SIGN-IN SYSTEM -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
  window.onload = () => {
    google.accounts.id.initialize({
      client_id: "624596716963-huc2ef9rt7q8vckvjtbr84tfrjbs5cic.apps.googleusercontent.com",
      callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
      document.getElementById("gSignIn"),
      { theme: "outline", size: "large" }
    );
    google.accounts.id.prompt();
  };

  async function handleCredentialResponse(response) {
    const userData = parseJwt(response.credential);
    if (userData.email === "ian@ishe-ltd.co.uk") {
      localStorage.setItem("user", JSON.stringify(userData));
      window.location.href = "boss-office.html";
    } else {
      alert("Access Denied: Not authorised");
    }
  }

  function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(
      atob(base64)
        .split('')
        .map(c => `%${('00' + c.charCodeAt(0).toString(16)).slice(-2)}`)
        .join('')
    );
    return JSON.parse(jsonPayload);
  }
</script>

<!-- üîê LOGIN.HTML PLACEHOLDER -->
<div id="gSignIn" class="flex justify-center mt-8"></div>

</body>
</html>