<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Accounts Office</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://rube.app/embed/chat?agent=crm-core-ai&apikey=YOUR_RUBE_API_KEY" defer></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-gray-800 rounded-xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-2">üìä Accounts Office ‚Äî Ava AI</h2>
            <p class="text-gray-300">All your business finances, tracking, and queries in one place.</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-3">üí∞ Account Snapshot</h3>
                <ul class="space-y-2 text-gray-300">
                    <li><strong>Bank Balance:</strong> ¬£{{BANK_BALANCE}}</li>
                    <li><strong>Outstanding Invoices:</strong> ¬£{{OUTSTANDING_INVOICES}}</li>
                    <li><strong>Expenses This Month:</strong> ¬£{{EXPENSES_THIS_MONTH}}</li>
                    <li><strong>Net Cash Flow:</strong> ¬£{{CASH_FLOW}}</li>
                </ul>
            </div>

            <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-3">üìÖ Upcoming Payments</h3>
                <ul class="space-y-2 text-gray-300">
                    <li>VAT Return ‚Äì Due {{VAT_DUE}}</li>
                    <li>Payroll ‚Äì Due {{PAYROLL_DATE}}</li>
                    <li>Supplier Invoice ‚Äì ¬£{{SUPPLIER_AMOUNT}} ({{SUPPLIER_NAME}})</li>
                </ul>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl p-6 mb-6">
            <h3 class="text-lg font-semibold mb-3">üîç Transactions Feed</h3>
            <iframe src="https://docs.google.com/spreadsheets/d/{{SPREADSHEET_ID}}/edit?usp=sharing" width="100%" height="300px" class="border-0 rounded"></iframe>
        </div>

        <div class="bg-gray-800 rounded-xl p-6">
            <h3 class="text-lg font-semibold mb-3">ü§ñ Chat with Ava ‚Äì Your Finance AI</h3>
            <script src="https://rube.app/embed/chat?agent=ava-accounts-ai&apikey=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJ1c2VyXzAxSzUyNDJUVllBTlBNTjIxTVdZWUtBVlk1Iiwib3JnSWQiOiJvcmdfMDFLNTI0MzI5TVkxOFo5SlhQQTJKM1kxOVkiLCJpYXQiOjE3NTkwNzMzNjB9.dlelFFUO-TRCVA4Q7d4n5xArhN5sxCBBm4VLFxmaMZM" defer></script>
        </div>

        <!-- Back Button -->
        <div class="mt-8 text-center">
            <a href="index.html" class="inline-block bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg font-semibold">
                ‚Üê Back to Office Dashboard
            </a>
        </div>
    </div>


    <script>
        function createInvoice() {
            alert('üìÑ Create Invoice\n\nPhilip can create invoices for all services:\n‚Ä¢ Gas Safety Certificates\n‚Ä¢ Event Planning\n‚Ä¢ Property Management\n\n‚úÖ Auto-integrated with accounting system');
        }

        function recordExpense() {
            alert('üí∏ Record Expense\n\nExpense categories:\n‚Ä¢ Office Supplies\n‚Ä¢ Equipment\n‚Ä¢ Professional Services\n\n‚úÖ Philip manages all business expenses');
        }

        function generateReport() {
            alert('üìà Financial Reports\n\nAvailable:\n‚Ä¢ P&L Statement\n‚Ä¢ Cash Flow\n‚Ä¢ Tax Summary\n\nüìä All auto-generated by Philip!');
        }

        function philipChat() {
            alert('üí¨ Message Philip\n\nPhilip manages the accounting system independently.\n\n‚úÖ He handles:\n‚Ä¢ Invoice creation\n‚Ä¢ Expense tracking\n‚Ä¢ Financial reporting\n‚Ä¢ VAT calculations');
        }

        function auditLog() {
            alert('üìú Audit Log\n\nRecent activities:\n‚Ä¢ Invoice created by Philip\n‚Ä¢ Expense recorded: ¬£125.50\n‚Ä¢ Payment received: ¬£85.00\n‚Ä¢ Monthly report generated\n\nüîç Full transparency!');
        }

        function migrationStatus() {
            alert('üîÑ QuickBooks Migration Status\n\n‚úÖ COMPLETE!\n\nMigrated:\n‚Ä¢ 3 years historical data\n‚Ä¢ All customer records\n‚Ä¢ Invoice templates\n‚Ä¢ Chart of accounts\n\nüéâ Philip now controls the system!');
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                let fileList = '';
                for (let i = 0; i < files.length; i++) {
                    fileList += `‚Ä¢ ${files[i].name} (${(files[i].size / 1024).toFixed(1)} KB)\n`;
                }
                alert(`üìÑ Files Selected for Upload\n\n${fileList}\n‚úÖ Files ready for processing by Philip\nüìä Will be integrated into accounting system`);
            }
        }

        function viewAllTransactions() {
            alert('üí≥ All Transactions\n\nShowing recent financial activity:\n\n‚úÖ 127 transactions this month\nüí∞ Total processed: ¬£45,230\nüìà Average transaction: ¬£356.14\nüéØ All reconciled and verified\n\nüìä Full details available in reports section');
        }

        // Task management functionality
        async function fetchAccountingTasks() {
            try {
                const res = await fetch("/api/tasks?office=accounts");
                const data = await res.json();
                const tasks = data.tasks || [];
                renderAccountingTasks(tasks);
            } catch (error) {
                console.log('API not available, using mock data:', error);
                // Fallback to mock data when API is not available
                const mockTasks = [
                    {
                        id: 1,
                        title: "Process month-end invoices",
                        status: "In Progress",
                        created_at: "2025-09-01T09:00:00Z",
                        updated_at: "2025-09-28T14:30:00Z"
                    },
                    {
                        id: 2,
                        title: "Reconcile bank statements",
                        status: "Pending",
                        created_at: "2025-09-15T10:00:00Z",
                        updated_at: "2025-09-25T16:20:00Z"
                    },
                    {
                        id: 3,
                        title: "Prepare quarterly VAT return",
                        status: "Done",
                        created_at: "2025-09-10T11:00:00Z",
                        updated_at: "2025-09-27T12:45:00Z"
                    }
                ];
                renderAccountingTasks(mockTasks);
            }
        }

        function renderAccountingTasks(tasks) {
            const taskList = document.getElementById('accountingTasks');
            if (!taskList) return;

            if (tasks.length === 0) {
                taskList.innerHTML = '<li class="p-4 bg-gray-800 border border-gray-600 rounded-xl shadow"><div class="text-gray-400 text-sm">No tasks found</div></li>';
                return;
            }

            taskList.innerHTML = tasks.map(task => `
                <li class="p-4 bg-gray-800 border border-gray-600 rounded-xl shadow">
                    <div class="font-semibold text-white">${task.title}</div>
                    <div class="text-sm text-gray-400">Status: ${task.status}</div>
                    <div class="text-xs text-gray-500">
                        Created: ${formatDate(task.created_at)} | Updated: ${formatDate(task.updated_at)}
                    </div>
                </li>
            `).join('');
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (error) {
                return dateString;
            }
        }

        // Initialize taskbar on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchAccountingTasks();
            // Refresh tasks every 30 seconds
            setInterval(fetchAccountingTasks, 30000);
        });
    </script>

    <script>
      const officeName = document.title || "CEO Office"; // auto-detect or hardcode per room
      const voiceMap = {
        "CEO Office": "Brian",
        "Admin Mailroom": "Stacy",
        "Logistics Office": "Ellie",
        "Accounts Office": "Ava",
        "Virtual Engineer": "Riley",
        "Therapy Room": "Luna"
      };

      window.addEventListener("load", () => {
        const aiAgent = document.querySelector("rube-chat-agent");
        if (aiAgent && voiceMap[officeName]) {
          aiAgent.setAttribute("voice", voiceMap[officeName]);
        }
      });
    </script>

</body>
</html>
