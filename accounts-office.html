<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Accounts Office</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://rube.app/embed/chat?agent=crm-core-ai&apikey=YOUR_RUBE_API_KEY" defer></script>
    <style>
        .status.warning { background-color: #d97706; }
        .status.ok { background-color: #059669; }
        .status.alert { background-color: #dc2626; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-gray-800 rounded-xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-2">📊 Accounts Office — Finance & Bookkeeping</h2>
            <p class="text-gray-300">Manage cashflow, invoices, receipts, and live AI bookkeeping chat.</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-3">📈 Live Cashflow</h3>
                <p class="text-gray-300 mb-3">Net Position: <strong class="text-white">£12,847.32</strong></p>
                <ul class="space-y-2 text-gray-300">
                    <li>⬆️ Income (This Week): £5,420</li>
                    <li>⬇️ Expenses (This Week): £2,300</li>
                    <li>💰 Pending Invoices: 4</li>
                </ul>
                <button class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm">Export CSV</button>
            </div>

            <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-3">🧾 Invoice Console</h3>
                <ul class="space-y-2 text-gray-300">
                    <li>Jones Heating – £450 – <span class="status bg-yellow-600 px-2 py-1 rounded text-xs text-white">Due</span></li>
                    <li>OVO Energy – £1,200 – <span class="status bg-green-600 px-2 py-1 rounded text-xs text-white">Paid</span></li>
                    <li>Tenant Refund – £220 – <span class="status bg-red-600 px-2 py-1 rounded text-xs text-white">Overdue</span></li>
                </ul>
                <button class="mt-4 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm">View All Invoices</button>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl p-6 mb-6">
            <h3 class="text-lg font-semibold mb-3">📥 Upload Bank Statements</h3>
            <input type="file" multiple class="block w-full text-sm text-gray-300 border border-gray-600 rounded bg-gray-700 p-2 mb-2" />
            <p class="text-xs text-gray-500">Drag & drop CSVs or PDFs from Gmail or Google Drive.</p>
        </div>

        <div class="bg-gray-800 rounded-xl p-6 mb-6">
            <h3 class="text-lg font-semibold mb-3">🤖 Talk to Ava – Accounts AI</h3>
            <script src="https://rube.app/embed/chat?agent=ava-accounts-ai&apikey=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJ1c2VyXzAxSzUyNDJUVllBTlBNTjIxTVdZWUtBVlk1Iiwib3JnSWQiOiJvcmdfMDFLNTI0MzI5TVkxOFo5SlhQQTJKM1kxOVkiLCJpYXQiOjE3NTkwNzMzNjB9.dlelFFUO-TRCVA4Q7d4n5xArhN5sxCBBm4VLFxmaMZM" defer></script>
        </div>

        <div class="bg-gray-800 rounded-xl p-6">

            <h3 class="text-lg font-semibold mb-3">📘 Finance Directive Pad</h3>
            <textarea 
                rows="4" 
                placeholder="Ava, always flag any invoice older than 14 days as priority..."
                class="w-full p-3 bg-gray-700 border border-gray-600 rounded text-gray-300 placeholder-gray-500"
            ></textarea>
            <button class="mt-3 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm">Update Directives</button>

            <h3 class="text-lg font-semibold mb-3">🤖 Chat with Ava – Your Finance AI</h3>
            <script src="https://rube.app/embed/chat?agent=ava-accounts-ai&apikey=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJ1c2VyXzAxSzUyNDJUVllBTlBNTjIxTVdZWUtBVlk1Iiwib3JnSWQiOiJvcmdfMDFLNTI0MzI5TVkxOFo5SlhQQTJKM1kxOVkiLCJpYXQiOjE3NTkwNzMzNjB9.dlelFFUO-TRCVA4Q7d4n5xArhN5sxCBBm4VLFxmaMZM" defer></script>

        </div>

        <!-- Back Button -->
        <div class="mt-8 text-center">
            <a href="index.html" class="inline-block bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg font-semibold">
                ← Back to Office Dashboard
            </a>
        </div>
    </div>


    <script>
        function exportCSV() {
            alert('📊 Export CSV\n\nCashflow data exported successfully!\n\n✅ File includes:\n• Net position\n• Weekly income/expenses\n• Pending invoices\n• Transaction history\n\n📁 Ready for download');
        }

        function viewAllInvoices() {
            alert('🧾 All Invoices\n\nShowing invoice summary:\n\n📋 Total invoices: 12\n💰 Outstanding amount: £2,870\n✅ Paid this month: £8,420\n⚠️ Overdue invoices: 1\n\n📊 Full invoice management available');
        }

        function updateDirectives() {
            const textarea = document.querySelector('textarea[placeholder*="Ava"]');
            const directives = textarea.value.trim();
            
            if (directives) {
                alert(`📘 Finance Directives Updated\n\nNew instructions for Ava:\n"${directives}"\n\n✅ Ava will apply these rules to all future financial operations`);
            } else {
                alert('📘 Finance Directives\n\nPlease enter specific instructions for Ava before updating directives.');
            }
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                let fileList = '';
                for (let i = 0; i < files.length; i++) {
                    fileList += `• ${files[i].name} (${(files[i].size / 1024).toFixed(1)} KB)\n`;
                }
                alert(`📥 Bank Statements Upload\n\n${fileList}\n✅ Files ready for processing by Ava\n📊 Will be integrated into accounting system\n💡 AI will automatically categorize transactions`);
            }
        }

        // Add event listeners when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Export CSV button
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.textContent.includes('Export CSV')) {
                    button.onclick = exportCSV;
                } else if (button.textContent.includes('View All Invoices')) {
                    button.onclick = viewAllInvoices;
                } else if (button.textContent.includes('Update Directives')) {
                    button.onclick = updateDirectives;
                }
            });
            
            // File upload input
            const fileInput = document.querySelector('input[type="file"]');
            if (fileInput) fileInput.onchange = handleFileUpload;
            
            // Initialize with sample directive text
            const textarea = document.querySelector('textarea[placeholder*="Ava"]');
            if (textarea && !textarea.value) {
                textarea.value = "Ava, always flag any invoice older than 14 days as priority...";
            }
        });

        function createInvoice() {
            alert('📄 Create Invoice\n\nPhilip can create invoices for all services:\n• Gas Safety Certificates\n• Event Planning\n• Property Management\n\n✅ Auto-integrated with accounting system');
        }

        function recordExpense() {
            alert('💸 Record Expense\n\nExpense categories:\n• Office Supplies\n• Equipment\n• Professional Services\n\n✅ Philip manages all business expenses');
        }

        function generateReport() {
            alert('📈 Financial Reports\n\nAvailable:\n• P&L Statement\n• Cash Flow\n• Tax Summary\n\n📊 All auto-generated by Philip!');
        }

        function philipChat() {
            alert('💬 Message Philip\n\nPhilip manages the accounting system independently.\n\n✅ He handles:\n• Invoice creation\n• Expense tracking\n• Financial reporting\n• VAT calculations');
        }

        function auditLog() {
            alert('📜 Audit Log\n\nRecent activities:\n• Invoice created by Philip\n• Expense recorded: £125.50\n• Payment received: £85.00\n• Monthly report generated\n\n🔍 Full transparency!');
        }

        function migrationStatus() {
            alert('🔄 QuickBooks Migration Status\n\n✅ COMPLETE!\n\nMigrated:\n• 3 years historical data\n• All customer records\n• Invoice templates\n• Chart of accounts\n\n🎉 Philip now controls the system!');
        }

        function viewAllTransactions() {
            alert('💳 All Transactions\n\nShowing recent financial activity:\n\n✅ 127 transactions this month\n💰 Total processed: £45,230\n📈 Average transaction: £356.14\n🎯 All reconciled and verified\n\n📊 Full details available in reports section');
        }

        // Task management functionality
        async function fetchAccountingTasks() {
            try {
                const res = await fetch("/api/tasks?office=accounts");
                const data = await res.json();
                const tasks = data.tasks || [];
                renderAccountingTasks(tasks);
            } catch (error) {
                console.log('API not available, using mock data:', error);
                // Fallback to mock data when API is not available
                const mockTasks = [
                    {
                        id: 1,
                        title: "Process month-end invoices",
                        status: "In Progress",
                        created_at: "2025-09-01T09:00:00Z",
                        updated_at: "2025-09-28T14:30:00Z"
                    },
                    {
                        id: 2,
                        title: "Reconcile bank statements",
                        status: "Pending",
                        created_at: "2025-09-15T10:00:00Z",
                        updated_at: "2025-09-25T16:20:00Z"
                    },
                    {
                        id: 3,
                        title: "Prepare quarterly VAT return",
                        status: "Done",
                        created_at: "2025-09-10T11:00:00Z",
                        updated_at: "2025-09-27T12:45:00Z"
                    }
                ];
                renderAccountingTasks(mockTasks);
            }
        }

        function renderAccountingTasks(tasks) {
            const taskList = document.getElementById('accountingTasks');
            if (!taskList) return;

            if (tasks.length === 0) {
                taskList.innerHTML = '<li class="p-4 bg-gray-800 border border-gray-600 rounded-xl shadow"><div class="text-gray-400 text-sm">No tasks found</div></li>';
                return;
            }

            taskList.innerHTML = tasks.map(task => `
                <li class="p-4 bg-gray-800 border border-gray-600 rounded-xl shadow">
                    <div class="font-semibold text-white">${task.title}</div>
                    <div class="text-sm text-gray-400">Status: ${task.status}</div>
                    <div class="text-xs text-gray-500">
                        Created: ${formatDate(task.created_at)} | Updated: ${formatDate(task.updated_at)}
                    </div>
                </li>
            `).join('');
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (error) {
                return dateString;
            }
        }

        // Initialize taskbar on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchAccountingTasks();
            // Refresh tasks every 30 seconds
            setInterval(fetchAccountingTasks, 30000);
        });
    </script>

<!-- GLOBAL CRM SETUP PAYLOAD FOR COPILOT DEPLOYMENT -->
<!-- DROP THIS INTO COPILOT AND DEPLOY ACROSS ALL HTML FILES -->
<!-- REPLACES GOOGLE AUTH, SUPERBASE CONNECTION, AND BACKEND SYNC -->

<!-- 🧠 LOAD RUBE CHATBOT WITH VOICE MAPPING -->
<script src="https://rube.app/embed/chat?agent=ellie-ai&apikey=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJ1c2VyXzAxSzUyNDJUVllBTlBNTjIxTVdZWUtBVlk1Iiwib3JnSWQiOiJvcmdfMDFLNTI0MzI5TVkxOFo5SlhQQTJKM1kxOVkiLCJpYXQiOjE3NTkwNzMzNjB9.dlelFFUO-TRCVA4Q7d4n5xArhN5sxCBBm4VLFxmaMZM"></script>
<script>
  const officeName = document.title || "CEO Office";
  const voiceMap = {
    "CEO Office": "Brian",
    "Admin Mailroom": "Stacy",
    "Logistics Office": "Ellie",
    "Accounts Office": "Ava",
    "Virtual Engineer": "Riley",
    "Therapy Room": "Luna"
  };
  window.addEventListener("load", () => {
    const aiAgent = document.querySelector("[rube-chat-agent]");
    if (aiAgent && voiceMap[officeName]) {
      aiAgent.setAttribute("voice", voiceMap[officeName]);
    }
  });
</script>

<!-- 🔑 SUPERBASE GLOBAL CONNECTION -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  window.supabase = createClient(
    'https://mydxasjicsfetnglbppp.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15ZHhhc2ppY3NmZXRuZ2xicHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMjYyNTQsImV4cCI6MjA3MzgwMjI1NH0.zdJa3T1WDdc6_JNQbh93oB7CnVWa5TQ5jLb1UN-8dLE'
  );
</script>

<!-- ✅ GOOGLE SIGN-IN SYSTEM -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
  window.onload = () => {
    google.accounts.id.initialize({
      client_id: "624596716963-huc2ef9rt7q8vckvjtbr84tfrjbs5cic.apps.googleusercontent.com",
      callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
      document.getElementById("gSignIn"),
      { theme: "outline", size: "large" }
    );
    google.accounts.id.prompt();
  };

  async function handleCredentialResponse(response) {
    const userData = parseJwt(response.credential);
    if (userData.email === "ian@ishe-ltd.co.uk") {
      localStorage.setItem("user", JSON.stringify(userData));
      window.location.href = "boss-office.html";
    } else {
      alert("Access Denied: Not authorised");
    }
  }

  function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(
      atob(base64)
        .split('')
        .map(c => `%${('00' + c.charCodeAt(0).toString(16)).slice(-2)}`)
        .join('')
    );
    return JSON.parse(jsonPayload);
  }
</script>

<!-- 🔐 LOGIN.HTML PLACEHOLDER -->
<div id="gSignIn" class="flex justify-center mt-8"></div>

</body>
</html>
