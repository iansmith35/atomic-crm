<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISHE GROUP CRM - Multi-Agent Office System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gray-800 p-8 text-center relative">
            <!-- Logout Button -->
            <div class="absolute top-4 right-4">
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm font-semibold">
                    üö™ Logout
                </button>
            </div>
            
            <h1 class="text-4xl font-bold text-blue-400 mb-2">‚öõÔ∏è ISHE Group CRM</h1>
            <p class="text-gray-300">Multi-Agent Autonomous Business Operations</p>
            <div class="mt-4 flex justify-center space-x-8">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400">42</div>
                    <div class="text-sm text-gray-400">Active Tasks</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400">11</div>
                    <div class="text-sm text-gray-400">Offices Online</div>
                </div>
            </div>
        </header>

        <!-- Offices Grid -->
        <main class="p-8">
            <h2 class="text-2xl font-bold mb-8 text-center">Your Office Network</h2>
            <div class="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">

 <!-- CEO Office -->
                <div class="bg-gradient-to-br from-purple-600 to-pink-600 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üíº</div>
                    <h3 class="text-xl font-bold">CEO Office</h3>
                    <p class="text-sm opacity-90">CEO </p>
                    <p class="text-sm opacity-80 mb-4">Executive oversight</p>
                    <div class="text-lg font-bold mb-4">12 Active Tasks</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='ceo-office.html'">
                        Open CEO Office
                    </button>
                </div>
                
                <!-- IT Office -->
                <div class="bg-gradient-to-br from-blue-500 to-purple-600 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üîß</div>
                    <h3 class="text-xl font-bold">IT Office</h3>
                    <p class="text-sm opacity-90">Rube </p>
                    <p class="text-sm opacity-80 mb-4">Technical support & development</p>
                    <div class="text-lg font-bold mb-4">8 Active Tasks</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='it-office.html'">
                        Open IT Office
                    </button>
                </div>

                               <!-- Admin Mail Room -->
                <div class="bg-gradient-to-br from-green-500 to-teal-600 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üì¨</div>
                    <h3 class="text-xl font-bold">Admin Mail Room</h3>
                    <p class="text-sm opacity-90">Stacy Smith Admin Manager </p>
                    <p class="text-sm opacity-80 mb-4">Gmail AI Assistant</p>
                    <div class="text-lg font-bold mb-4">15 Active Tasks</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='communications-office.html'">
                        Open Admin Mail Room
                    </button>
                </div>

                <!-- Virtual Engineer -->
                <div class="bg-gradient-to-br from-yellow-500 to-orange-600 p-6 rounded-xl">
                    <div class="text-4xl mb-4">‚öôÔ∏è</div>
                    <h3 class="text-xl font-bold">Virtual Engineer</h3>
                    <p class="text-sm opacity-90">Virtual Ian</p>
                    <p class="text-sm opacity-80 mb-4">Gas safety certificates</p>
                    <div class="text-lg font-bold mb-4">6 Active Tasks</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='virtual-engineer-office.html'">
                        Open Engineer Office
                    </button>
                </div>

                <!-- ISHE Group Accounts -->
                <div class="bg-gradient-to-br from-emerald-500 to-green-600 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üí∞</div>
                    <h3 class="text-xl font-bold">Accounts Office</h3>
                    <p class="text-sm opacity-90">Philip Jones Accounts Manger </p>
                    <p class="text-sm opacity-80 mb-4">Custom accounting system</p>
                    <div class="text-lg font-bold mb-4">4 Active Tasks</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='accounts-office.html'">
                        Open Accounts
                    </button>
                </div>

                <!-- Logistics -->
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üìÖ</div>
                    <h3 class="text-xl font-bold">Logistics</h3>
                    <p class="text-sm opacity-90">Logistics</p>
                    <p class="text-sm opacity-80 mb-4">Calendar management</p>
                    <div class="text-lg font-bold mb-4">7 Active Tasks</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='Logistics-office.html'">
                        Open Logistics
                    </button>
                </div>

                <!-- Kinky Brizzle -->
                <div class="bg-gradient-to-br from-pink-500 to-rose-600 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üé≠</div>
                    <h3 class="text-xl font-bold">KinkyBrizzle</h3>
                    <p class="text-sm opacity-90">KinkyBrizzle AI</p>
                    <p class="text-sm opacity-80 mb-4">Adult brand management + Printful</p>
                    <div class="text-lg font-bold mb-4">23 Active Orders</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='kinky-brizzle-office.html'">
                        Open KinkyBrizzle
                    </button>
                </div>

                <!-- Event Safe -->
                <div class="bg-gradient-to-br from-cyan-500 to-blue-600 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üéâ</div>
                    <h3 class="text-xl font-bold">Events Safe Office</h3>
                    <p class="text-sm opacity-90">Events Safe </p>
                    <p class="text-sm opacity-80 mb-4">Event Safe Id</p>
                    <div class="text-lg font-bold mb-4">5 Active Tasks</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="alert('Opening Events Safe - Event Safe planning services')">
                        Open Events Safe
                    </button>
                </div>

                <!-- CoastView Park Holiday Letting Office -->
                <div class="bg-gradient-to-br from-teal-500 to-cyan-600 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üè†</div>
                    <h3 class="text-xl font-bold">CoastView</h3>
                    <p class="text-sm opacity-90">Peter Ellis - Holiday Letting Admin</p>
                    <p class="text-sm opacity-80 mb-4">holiday letting management</p>
                    <div class="text-lg font-bold mb-4">15 Active Properties</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='coastview-office.html'">
                        Open CoastView Park
                    </button>
                </div>

                <!-- Music Production Studio -->
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üéµ</div>
                    <h3 class="text-xl font-bold">Music Studio</h3>
                    <p class="text-sm opacity-90">AI Producer & Real Studio</p>
                    <p class="text-sm opacity-80 mb-4">Professional music production</p>
                    <div class="text-lg font-bold mb-4">3 Active Projects</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='music-studio-office.html'">
                        Open Music Studio
                    </button>
                </div>

                <!-- Boss's Office -->
                <div class="bg-gradient-to-br from-gray-600 to-gray-800 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üëî</div>
                    <h3 class="text-xl font-bold">Boss's Office</h3>
                    <p class="text-sm opacity-90">Executive AI Assistant</p>
                    <p class="text-sm opacity-80 mb-4">Strategic oversight & executive decisions</p>
                    <div class="text-lg font-bold mb-4">15 Executive Tasks</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='boss-office.html'">
                        Open Boss's Office
                    </button>
                </div>

                <!-- Therapy Office -->
                <div class="bg-gradient-to-br from-green-400 to-teal-500 p-6 rounded-xl">
                    <div class="text-4xl mb-4">üßò‚Äç‚ôÄÔ∏è</div>
                    <h3 class="text-xl font-bold">Therapy Office</h3>
                    <p class="text-sm opacity-90">Luna - AI Therapist</p>
                    <p class="text-sm opacity-80 mb-4">Mental wellness & support</p>
                    <div class="text-lg font-bold mb-4">3 Active Sessions</div>
                    <button class="w-full bg-white bg-opacity-20 p-2 rounded" onclick="window.location.href='therapy-office.html'">
                        Open Therapy Office
                    </button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-center p-6 mt-12">
            <p class="text-gray-400"> ISHE Group </p>
        </footer>
    </div>

<!-- üîê LOGIN.HTML PLACEHOLDER (DISABLED) -->
<!-- <div id="gSignIn" class="flex justify-center mt-8"></div> -->

<!-- GLOBAL CRM SETUP PAYLOAD FOR COPILOT DEPLOYMENT -->
<!-- DROP THIS INTO COPILOT AND DEPLOY ACROSS ALL HTML FILES -->
<!-- REPLACES GOOGLE AUTH, SUPERBASE CONNECTION, AND BACKEND SYNC -->

<!-- üß† LOAD RUBE CHATBOT WITH VOICE MAPPING -->

<script src="https://rube.app/embed/chat?agent=engineer-ai&voice=Riley-UK-Female&apikey=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJ1c2VyXzAxSzUyNDJUVllBTlBNTjIxTVdZWUtBVlk1Iiwib3JnSWQiOiJvcmdfMDFLNTI0MzI5TVkxOFo5SlhQQTJKM1kxOVkiLCJpYXQiOjE3NTkxNTIzMzN9.-RR_XvifD7r8Z0kWanIiR5Sy9y5EIzftPQqfd5jTLxM"></script>



<script>
// ===== FULL ATOMIC CRM INTEGRATION =====
// Connects dashboard to real Supabase data: offices, tasks, contacts, calendar

let supabaseClient;

// Initialize Supabase
function initSupabase() {
    if (window.supabase && SUPABASE_CONFIG) {
        supabaseClient = window.supabase.createClient(
            SUPABASE_CONFIG.url,
            SUPABASE_CONFIG.anonKey
        );
        return true;
    }
    return false;
}

// Load all dashboard data
async function loadFullDashboard() {
    if (!initSupabase()) {
        console.error('Supabase not initialized');
        return;
    }

    try {
        // Load in parallel for speed
        await Promise.all([
            loadDashboardStats(),
            loadOfficeCards(),
            loadRecentContacts(),
            loadUpcomingCalendar()
        ]);

        console.log('‚úì Full dashboard loaded');
    } catch (error) {
        console.error('Dashboard load error:', error);
    }
}

// Load dashboard stats (tasks & offices)
async function loadDashboardStats() {
    try {
        // Active tasks count
        const { count: taskCount } = await supabaseClient
            .from('tasks')
            .select('*', { count: 'exact', head: true })
            .not('status', 'in', '("completed","closed")');

        if (taskCount !== null) {
            document.getElementById('activeTasksCount').textContent = taskCount;
        }

        // Offices count
        const { count: officeCount } = await supabaseClient
            .from('office_personas')
            .select('*', { count: 'exact', head: true });

        if (officeCount !== null) {
            document.getElementById('officesOnlineCount').textContent = officeCount;
        }

    } catch (error) {
        console.error('Stats load error:', error);
    }
}

// Load and display office cards with real data
async function loadOfficeCards() {
    try {
        // Get all offices
        const { data: offices, error: officeError } = await supabaseClient
            .from('office_personas')
            .select('*')
            .order('office');

        if (officeError) throw officeError;

        // Get task counts per office/category
        const { data: taskCounts } = await supabaseClient
            .rpc('get_task_counts_by_category')
            .catch(() => {
                // Fallback: get all tasks and count manually
                return supabaseClient
                    .from('tasks')
                    .select('category, assigned_to, status')
                    .not('status', 'in', '("completed","closed")');
            });

        // Find office card container
        const officeContainer = document.querySelector('.grid') || 
                               document.querySelector('[class*="office"]') ||
                               document.body;

        // Build office cards HTML
        const officeCardsHTML = offices.map(office => {
            // Match tasks to office (by category or assignment)
            const officeTasks = taskCounts?.filter(t => 
                t.category?.toLowerCase() === office.office.toLowerCase() ||
                t.assigned_to?.toLowerCase().includes(office.name.toLowerCase())
            ) || [];

            const taskCount = officeTasks.reduce((sum, t) => sum + (t.count || 1), 0);

            return `
                <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all cursor-pointer" 
                     onclick="openOffice('${office.office}')">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl">üíº</span>
                        <span class="text-white text-sm bg-white/20 px-3 py-1 rounded-full">
                            ${office.office.toUpperCase()}
                        </span>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">${office.name}</h3>
                    <p class="text-purple-100 text-sm mb-4">${office.office} Office</p>
                    <div class="text-3xl font-bold text-white mb-4">${taskCount} Active Tasks</div>
                    <button class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-3 px-4 rounded-lg transition-all">
                        Open ${office.name}'s Office
                    </button>
                </div>
            `;
        }).join('');

        // Insert office cards (or update existing container)
        const existingCards = document.querySelector('#officeCardsContainer');
        if (existingCards) {
            existingCards.innerHTML = officeCardsHTML;
        }

        console.log(`‚úì Loaded ${offices.length} offices`);

    } catch (error) {
        console.error('Office cards load error:', error);
    }
}

// Load recent contacts
async function loadRecentContacts() {
    try {
        const { data: contacts, error } = await supabaseClient
            .from('contacts')
            .select('*')
            .order('updated_at', { ascending: false })
            .limit(5);

        if (error) throw error;

        console.log(`‚úì Loaded ${contacts.length} recent contacts`);
        // Store for later use
        window.recentContacts = contacts;

    } catch (error) {
        console.error('Contacts load error:', error);
    }
}

// Load upcoming calendar events
async function loadUpcomingCalendar() {
    try {
        const today = new Date().toISOString();

        const { data: events, error } = await supabaseClient
            .from('calendar_event_backups')
            .select('*')
            .gte('start_time', today)
            .order('start_time', { ascending: true })
            .limit(10);

        if (error) throw error;

        console.log(`‚úì Loaded ${events.length} upcoming events`);
        // Store for later use
        window.upcomingEvents = events;

    } catch (error) {
        console.error('Calendar load error:', error);
    }
}

// Open office page
function openOffice(officeId) {
    // Check if office-specific HTML exists
    const officePages = {
        'ceo': 'CEO-office.html',
        'accounts': 'accounts-office.html',
        'scheduling': 'scheduling-office.html',
        'engineer': 'IT-office.html',
        'kinky-brizzle': 'kinky-brizzle-office.html'
    };

    const pagePath = officePages[officeId] || `${officeId}-office.html`;
    window.location.href = pagePath;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', loadFullDashboard);

// Refresh every 30 seconds
setInterval(loadDashboardStats, 30000);
</script>

</body>
</html>
