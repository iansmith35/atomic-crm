<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Admin Mailroom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://rube.app/embed/chat?agent=crm-core-ai&apikey=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJ1c2VyXzAxSzUyNDJUVllBTlBNTjIxTVdZWUtBVlk1Iiwib3JnSWQiOiJvcmdfMDFLNTI0MzI5TVkxOFo5SlhQQTJKM1kxOVkiLCJpYXQiOjE3NTkwNzMzNjB9.dlelFFUO-TRCVA4Q7d4n5xArhN5sxCBBm4VLFxmaMZM" defer></script>

</head>
<body class="min-h-screen">
    <div class="p-6 max-w-6xl mx-auto">
        <div class="panel">
            <h2 class="text-3xl font-bold text-gray-800">📬 Admin Mailroom — Full Email Console</h2>
            <p class="text-gray-600">Live inbox, pre-approved replies, message tracking, and AI-powered handling.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
            <div class="panel">
                <h3 class="text-xl font-semibold">📥 Live Email Log</h3>
                <div id="emailContainer" class="grid grid-cols-1 gap-3 bg-white p-4 rounded border" style="height: 350px; overflow-y: auto;">
                    <!-- Emails will be loaded here -->
                </div>
                <p class="text-sm text-gray-600 mt-2">Unread emails from Gmail API</p>
            </div>

            <div class="panel">
                <h3 class="text-xl font-semibold">📤 Compose Email</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">To:</label>
                        <input
                            type="email"
                            id="toField"
                            class="w-full border p-2 rounded"
                            placeholder="recipient@example.com"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Subject:</label>
                        <input
                            type="text"
                            id="subjectField"
                            class="w-full border p-2 rounded"
                            placeholder="Email subject"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Message:</label>
                        <textarea
                            id="bodyField"
                            class="w-full border p-2 rounded"
                            rows="4"
                            placeholder="Email content"
                        ></textarea>
                    </div>
                    <button
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                        onclick="onSendEmail()"
                        id="sendButton"
                    >
                        Send Email
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
            <div class="panel">
                <h3 class="text-xl font-semibold">📝 Pre-Approved Replies</h3>
                <ul class="mb-4 space-y-2">
                    <li class="flex items-center">
                        <span class="text-green-600 mr-2">✅</span>
                        "Thanks for your message — I'll get back shortly."
                    </li>
                    <li class="flex items-center">
                        <span class="text-green-600 mr-2">✅</span>
                        "Yes, I can confirm that appointment."
                    </li>
                    <li class="flex items-center">
                        <span class="text-green-600 mr-2">✅</span>
                        "Here's your requested documentation."
                    </li>
                </ul>
                <textarea 
                    class="w-full p-2 border rounded mb-2" 
                    rows="3"
                    placeholder="Draft new pre-approvals..."
                    id="newReplyText"
                ></textarea>
                <button 
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                    onclick="savePreApprovedReply()"
                >
                    Save
                </button>
            </div>
        </div>

        <div class="panel">
            <h3 class="text-xl font-semibold">🤖 Talk to Stacy – Mailroom AI</h3>
            <div class="bg-gray-50 border rounded p-4 mb-4">
                <div id="stacyChat" class="h-64 overflow-y-auto mb-4">
                    <div class="mb-2">
                        <strong class="text-blue-600">Stacy:</strong> 
                        <span class="text-gray-700">Hello! I'm Stacy, your AI mailroom assistant. I can help you manage emails, draft replies, and keep track of important messages. What would you like me to help you with today?</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="stacyInput" 
                        class="flex-1 p-2 border rounded" 
                        placeholder="Ask Stacy about emails, drafts, or anything else..."
                        onkeypress="handleStacyKeyPress(event)"
                    />
                    <button 
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                        onclick="sendStacyMessage()"
                    >
                        Send
                    </button>
                </div>
            </div>
            <!-- External AI Chat Integration -->
            <script src="https://rube.app/embed/chat?agent=stacy-mail-ai&apikey=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJ1c2VyXzAxSzUyNDJUVllBTlBNTjIxTVdZWUtBVlk1Iiwib3JnSWQiOiJvcmdfMDFLNTI0MzI5TVkxOFo5SlhQQTJKM1kxOVkiLCJpYXQiOjE3NTkwNzMzNjB9.dlelFFUO-TRCVA4Q7d4n5xArhN5sxCBBm4VLFxmaMZM" defer></script>
        </div>

        <div class="panel">
            <h3 class="text-xl font-semibold">📋 Email Task Tracker</h3>
            <ul class="space-y-2" id="emailTaskTracker">
                <li class="flex items-center justify-between p-3 bg-yellow-50 rounded border-l-4 border-yellow-400">
                    <span>📌 Drafts needing approval</span>
                    <span class="font-bold text-yellow-600">3</span>
                </li>
                <li class="flex items-center justify-between p-3 bg-red-50 rounded border-l-4 border-red-400">
                    <span>⚠️ Unread important</span>
                    <span class="font-bold text-red-600">6</span>
                </li>
                <li class="flex items-center justify-between p-3 bg-green-50 rounded border-l-4 border-green-400">
                    <span>✔️ Replied and archived</span>
                    <span class="font-bold text-green-600">12</span>
                </li>

            </ul>
            <p class="text-sm text-gray-600 mt-4">Stacy will prompt if any email goes unhandled over 24h.</p>
        </div>

        <!-- Back Button -->
        <div class="mt-8 text-center">
            <a href="index.html" class="inline-block bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold">
                ← Back to Office Dashboard
            </a>
        </div>
    </div>

    <script>
        // Pre-approved replies storage
        let preApprovedReplies = [
            "Thanks for your message — I'll get back shortly.",
            "Yes, I can confirm that appointment.",
            "Here's your requested documentation."
        ];

        // Email task tracker data
        let emailTasks = {
            drafts: 3,
            unreadImportant: 6,
            repliedArchived: 12
        };

        // Stacy chat history
        let stacyChatHistory = [];

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            updateEmailTaskTracker();
            loadStacyChat();
            loadEmails(); // Load emails on page load
        });

        // Get unread emails from Gmail API
        async function getUnreadEmails() {
            try {
                const response = await fetch('/api/gmail/unread');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const emails = await response.json();
                return emails;
            } catch (error) {
                console.error('Error fetching unread emails:', error);
                throw error;
            }
        }

        // Send an email using Gmail API
        async function sendEmail(to, subject, body) {
            try {
                const response = await fetch('/api/gmail/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ to, subject, body }),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error sending email:', error);
                throw error;
            }
        }

        // Load emails equivalent to useEffect
        function loadEmails() {
            getUnreadEmails()
                .then(msgs => displayEmails(msgs))
                .catch(err => {
                    console.error('Error fetching emails:', err);
                    showNotification('Error loading emails', 'error');
                });
        }

        // Display emails in the container
        function displayEmails(emails) {
            const container = document.getElementById('emailContainer');
            container.innerHTML = '';
            
            if (emails.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">No unread emails</p>';
                return;
            }
            
            emails.forEach(email => {
                const emailDiv = document.createElement('div');
                emailDiv.className = 'p-3 border rounded shadow-sm bg-gray-50';
                emailDiv.innerHTML = `
                    <strong>${email.subject}</strong><br />
                    From: ${email.from}<br />
                    Date: ${new Date(email.date).toLocaleString()}<br />
                    <p class="text-sm mt-2">${email.snippet}</p>
                `;
                container.appendChild(emailDiv);
            });
        }

        // Send email function equivalent to onSendEmail
        function onSendEmail() {
            const toField = document.getElementById('toField').value;
            const subjectField = document.getElementById('subjectField').value;
            const bodyField = document.getElementById('bodyField').value;
            
            if (!toField || !subjectField || !bodyField) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            // Disable send button during sending
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            
            sendEmail(toField, subjectField, bodyField)
                .then(res => {
                    showNotification('Email sent successfully!', 'success');
                    // Clear form
                    document.getElementById('toField').value = '';
                    document.getElementById('subjectField').value = '';
                    document.getElementById('bodyField').value = '';
                    // Refresh emails
                    return getUnreadEmails();
                })
                .then(refresh => displayEmails(refresh))
                .catch(err => {
                    console.error('Error sending email:', err);
                    showNotification('Error sending email', 'error');
                })
                .finally(() => {
                    // Re-enable send button
                    sendButton.disabled = false;
                    sendButton.textContent = 'Send Email';
                });
        }

        // Save new pre-approved reply
        function savePreApprovedReply() {
            const textarea = document.getElementById('newReplyText');
            const newReply = textarea.value.trim();
            
            if (newReply) {
                preApprovedReplies.push(newReply);
                textarea.value = '';
                
                // Add new reply to the list
                const repliesList = document.querySelector('.panel ul');
                const newLi = document.createElement('li');
                newLi.className = 'flex items-center';
                newLi.innerHTML = `
                    <span class="text-green-600 mr-2">✅</span>
                    "${newReply}"
                `;
                repliesList.appendChild(newLi);
                
                // Show confirmation
                showNotification('Pre-approved reply saved successfully!', 'success');
            }
        }

        // Handle Stacy chat key press
        function handleStacyKeyPress(event) {
            if (event.key === 'Enter') {
                sendStacyMessage();
            }
        }

        // Send message to Stacy
        function sendStacyMessage() {
            const input = document.getElementById('stacyInput');
            const message = input.value.trim();
            
            if (message) {
                // Add user message to chat
                addMessageToStacyChat('user', message);
                input.value = '';
                
                // Simulate AI response (in real implementation, this would call the API)
                setTimeout(() => {
                    const response = generateStacyResponse(message);
                    addMessageToStacyChat('stacy', response);
                }, 1000);
            }
        }

        // Add message to Stacy chat
        function addMessageToStacyChat(sender, message) {
            const chatDiv = document.getElementById('stacyChat');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'mb-2';
            
            const senderName = sender === 'user' ? 'You' : 'Stacy';
            const senderColor = sender === 'user' ? 'text-gray-800' : 'text-blue-600';
            
            messageDiv.innerHTML = `
                <strong class="${senderColor}">${senderName}:</strong> 
                <span class="text-gray-700">${message}</span>
            `;
            
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            
            // Store in history
            stacyChatHistory.push({ sender, message, timestamp: new Date() });
        }

        // Generate simulated Stacy responses
        function generateStacyResponse(userMessage) {
            const responses = [
                "I'll help you with that email task right away. Let me check your inbox for any urgent messages.",
                "That sounds like a great idea! I can draft a reply for you. Would you like me to use one of your pre-approved templates?",
                "I've analyzed your recent email patterns. You have some important messages that need attention.",
                "I can help you organize those emails better. Would you like me to create some filters or labels?",
                "Based on your email activity, I recommend checking your important folder. There are some time-sensitive messages there.",
                "I'll add that to your email task list. Is there a specific deadline for this task?",
                "Your email management is looking good today! You've handled most of your priority messages."
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // Load initial Stacy chat
        function loadStacyChat() {
            // Initial greeting is already in HTML
            stacyChatHistory.push({
                sender: 'stacy',
                message: "Hello! I'm Stacy, your AI mailroom assistant. I can help you manage emails, draft replies, and keep track of important messages. What would you like me to help you with today?",
                timestamp: new Date()
            });
        }

        // Update email task tracker
        function updateEmailTaskTracker() {
            // This would typically fetch real data from an API
            // For now, we'll simulate some dynamic updates
            setTimeout(() => {
                // Simulate some changes in email tasks
                if (Math.random() > 0.7) {
                    emailTasks.unreadImportant += 1;
                    updateTaskDisplay();
                }
            }, 5000);
        }

        // Update task display
        function updateTaskDisplay() {
            const tracker = document.getElementById('emailTaskTracker');
            tracker.innerHTML = `
                <li class="flex items-center justify-between p-3 bg-yellow-50 rounded border-l-4 border-yellow-400">
                    <span>📌 Drafts needing approval</span>
                    <span class="font-bold text-yellow-600">${emailTasks.drafts}</span>
                </li>
                <li class="flex items-center justify-between p-3 bg-red-50 rounded border-l-4 border-red-400">
                    <span>⚠️ Unread important</span>
                    <span class="font-bold text-red-600">${emailTasks.unreadImportant}</span>
                </li>
                <li class="flex items-center justify-between p-3 bg-green-50 rounded border-l-4 border-green-400">
                    <span>✔️ Replied and archived</span>
                    <span class="font-bold text-green-600">${emailTasks.repliedArchived}</span>
                </li>
            `;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Simulate periodic email updates
        setInterval(() => {
            if (Math.random() > 0.8) {
                // Randomly update task counts to simulate activity
                if (Math.random() > 0.5) {
                    emailTasks.repliedArchived += 1;
                    emailTasks.unreadImportant = Math.max(0, emailTasks.unreadImportant - 1);
                } else {
                    emailTasks.unreadImportant += 1;
                }
                updateTaskDisplay();
            }
        }, 10000); // Update every 10 seconds
    </script>

<!-- GLOBAL CRM SETUP PAYLOAD FOR COPILOT DEPLOYMENT -->
<!-- DROP THIS INTO COPILOT AND DEPLOY ACROSS ALL HTML FILES -->
<!-- REPLACES GOOGLE AUTH, SUPERBASE CONNECTION, AND BACKEND SYNC -->

<!-- 🧠 LOAD RUBE CHATBOT WITH VOICE MAPPING -->
<script src="https://rube.app/embed/chat?agent=ellie-ai&apikey=eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJ1c2VyXzAxSzUyNDJUVllBTlBNTjIxTVdZWUtBVlk1Iiwib3JnSWQiOiJvcmdfMDFLNTI0MzI5TVkxOFo5SlhQQTJKM1kxOVkiLCJpYXQiOjE3NTkwNzMzNjB9.dlelFFUO-TRCVA4Q7d4n5xArhN5sxCBBm4VLFxmaMZM"></script>
<script>
  const officeName = document.title || "CEO Office";
  const voiceMap = {
    "CEO Office": "Brian",
    "Admin Mailroom": "Stacy",
    "Logistics Office": "Ellie",
    "Accounts Office": "Ava",
    "Virtual Engineer": "Riley",
    "Therapy Room": "Luna"
  };
  window.addEventListener("load", () => {
    const aiAgent = document.querySelector("[rube-chat-agent]");
    if (aiAgent && voiceMap[officeName]) {
      aiAgent.setAttribute("voice", voiceMap[officeName]);
    }
  });
</script>

<!-- 🔑 SUPERBASE GLOBAL CONNECTION -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  window.supabase = createClient(
    'https://mydxasjicsfetnglbppp.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15ZHhhc2ppY3NmZXRuZ2xicHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMjYyNTQsImV4cCI6MjA3MzgwMjI1NH0.zdJa3T1WDdc6_JNQbh93oB7CnVWa5TQ5jLb1UN-8dLE'
  );
</script>

<!-- DISABLED: Google OAuth Block
<!-- ✅ GOOGLE SIGN-IN SYSTEM -->
<!-- <script src="https://accounts.google.com/gsi/client" async defer></script> (DISABLED) -->
<script>
  window.onload = () => {
    google.accounts.id.initialize({
      client_id: "624596716963-huc2ef9rt7q8vckvjtbr84tfrjbs5cic.apps.googleusercontent.com",
      callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
      document.getElementById("gSignIn"),
      { theme: "outline", size: "large" }
    );
    google.accounts.id.prompt();
  };

  async function handleCredentialResponse(response) {
    const userData = parseJwt(response.credential);
    if (userData.email === "ian@ishe-ltd.co.uk") {
      localStorage.setItem("user", JSON.stringify(userData));
      window.location.href = "boss-office.html";
    } else {
      alert("Access Denied: Not authorised");
    }
  }

  function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(
      atob(base64)
        .split('')
        .map(c => `%${('00' + c.charCodeAt(0).toString(16)).slice(-2)}`)
        .join('')
    );
    return JSON.parse(jsonPayload);
  }
</script>
-->

<!-- 🔐 LOGIN.HTML PLACEHOLDER -->
<!-- <div id="gSignIn" class="flex justify-center mt-8"></div> (DISABLED) -->

<!-- DISABLED: Supabase OAuth Handler
<!-- Google OAuth Login Handler -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
  const supabase = createClient(
    'https://mydxasjcsfetnglbppp.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15ZHhhc2ppY3NmZXRuZ2xicHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMjYyNTQsImV4cCI6MjA3MzgwMjI1NH0.zdJa3T1WDdc6_JNQbh93oB7CnVWa5TQ5jLb1UN-8dLE'
  )
  const loginBtn = document.querySelector('#login-button')
  loginBtn.addEventListener('click', async () => {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
    })
    if (error) console.error('Login error:', error.message)
  })
</script>
-->

</body>
</html>
